{% extends 'main/base.html' %}

{% load static i18n widget_tweaks mptt_tags %}

{% block extra_js %}
    <script src="{% static 'js/jquery-3.6.4.min.js' %}"></script>
{% endblock %}

{% block extra_css %}
    <style>
        .responsive {
            width: 100%;
            height: auto;
        }
    </style>
{% endblock %}

{% block apptitle %}
    {% include 'padanukkama/include/title.html' %} : {% trans 'Pada' %}・{% trans 'Vipatti' %}
{% endblock %}

{% block apptitle_option %}
    <a href="{% url 'padanukkama_pada' pada.padanukkama_id %}"
        class="w3-button w3-round-xlarge w3-hover-amber w3-display-right">
        {% trans "Back" %}
    </a>
{% endblock %}

{% block body %}
    <div class="w3-container w3-light-grey">
        <h4>{{ pada }} {% if pada.parent %}<small>({{ pada.get_parent_and_siblings }})</small>{% endif %}
            <span class="w3-right">{{ padanukkama }}</span>
        </h4>
    </div>

    <div class="w3-cell-row">
        <!-- left panel -->
        <div class="w3-container w3-cell" style="width:60%">
            <div class="w3-cell-row w3-margin-bottom">
                <form action="" method="post"
                    class="w3-container w3-text-blue w3-padding"
                    style="width:60%;margin:auto;">
                    {% csrf_token %}
                    {% for field in form %}
                        <p>
                            <label>{% trans field.label_tag %}</label>
                            {{ field|add_class:"w3-input" }}
                        </p>
                    {% endfor %}
                </form>

                <div id="result-container"></div>
            </div>
        </div>

        <!-- right panel -->
        <div class="w3-container">
            <div class="w3-bar w3-light-grey">
                <button class="w3-bar-item w3-button tablink w3-grey" onclick="openTabs(event,'Abidan')">{% trans 'Abidan' %}</button>
                <button class="w3-bar-item w3-button tablink" onclick="openTabs(event,'Sadda')">{% trans 'Sadda' %}</button>
            </div>

            <div id="Abidan" class="w3-border tab">
                <header class="w3-container w3-light-grey">
                    <h5>{% trans 'Closest matching words in Abidan' %}</h5>
                </header>

                <div class="w3-container w3-padding">
                    <ul id="abidan-closest-matches" class="w3-ul w3-hoverable">
                    </ul>
                </div>
            </div>

            <div id="Sadda" class="w3-border tab" style="display:none">
                <header class="w3-container w3-light-grey">
                    <h5>{% trans 'Closest matching words in Sadda' %}</h5>
                </header>

                <div class="w3-container w3-padding">
                    <ul id="sadda-closest-matches" class="w3-ul w3-hoverable">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Add the image modal markup -->
    <div id="imageModal" class="w3-modal">
        <div class="w3-modal-content w3-animate-zoom">
            <div class="w3-container">
                <span class="w3-button w3-hover-red w3-xlarge w3-display-topright" onclick="closeModal()">&times;</span>
                <img id="modalImage" class="responsive" src="" alt="Modal Image">
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
    <script src="{% static 'padanukkama/modals.js' %}"></script>
    <script src="{% static 'padanukkama/tabs.js' %}"></script>
    
    <script>
        $(document).ready(function() {
            // find_abidan_closest_matches
            $.ajax({
                url: '{% url "find_abidan_closest_matches" %}',
                type: 'GET',
                data: {
                    'string': '{{ pada.pada }}'
                },
                beforeSend: function() {
                    // Show the loading message before making the AJAX request
                    $('#abidan-closest-matches').html('<i id="loading-icon" class="fa fa-spinner fa-spin"></i> {% trans 'Loading...' %}');
                },
                success: function(response) {
                    var closestMatches = response.closest_matches;
                    var matchesHtml = '';

                    // Generate the HTML for displaying the closest matches
                    if (closestMatches.length === 0) {
                        matchesHtml = '<li>No matches found.</li>';
                    } else {
                        for (var i = 0; i < closestMatches.length; i++) {
                            var abidanDetailsUrl = '{% url 'abidan_details' pk=0 %}'.replace('0', closestMatches[i].id);

                            // Wrap the image with a link to open the modal
                            matchesHtml += '<div class="w3-cell-row">';
                            matchesHtml +=      '<div class="w3-container w3-cell" style="width:15%">';
                            matchesHtml +=          '<img src="' + closestMatches[i].image_ref + '" class="responsive" ';
                            matchesHtml +=          'style="cursor: pointer;" ';
                            matchesHtml +=          'onclick="openModal(\'' + closestMatches[i].image_ref + '\')"/>';
                            matchesHtml +=      '</div>'

                            matchesHtml +=      '<div class="w3-container w3-cell">';
                            matchesHtml +=           '<p>' + closestMatches[i].dict + '<br>';
                            matchesHtml +=           closestMatches[i].burmese;
                            matchesHtml +=           '<a class="w3-btn" style="text-decoration:None;hover:pointer;" target="_blank" ';
                            matchesHtml +=           'href="' + abidanDetailsUrl + '"> <i class="fas fa-link"></i></a><br>';
                            matchesHtml +=           '<div class="w3-light-grey w3-tiny" style="width:100px;">'
                            matchesHtml +=               '<div class="w3-container w3-green" style="width:'+ closestMatches[i].score +'%">'
                            matchesHtml +=                  closestMatches[i].score + '%';
                            matchesHtml +=               '</div>';
                            matchesHtml +=           '</div>';
                            matchesHtml +=      '</div>';
                            matchesHtml += '</div>';
                        }
                    }

                    // Update the abidan-closest-matches ul with the generated HTML
                    $('#abidan-closest-matches').html(matchesHtml);
                }
            });


            // find_sadda_closest_matches
            $.ajax({
                url: '{% url "find_sadda_closest_matches" %}',
                type: 'GET',
                data: {
                    'string': '{{ pada.pada }}'
                },
                beforeSend: function() {
                    // Show the loading message before making the AJAX request
                    $('#sadda-closest-matches').html('<i id="loading-icon" class="fa fa-spinner fa-spin"></i> {% trans 'Loading...' %}');
                },
                success: function(response) {
                    var closestMatches = response.closest_matches;
                    var matchesHtml = '';

                    // Generate the HTML for displaying the closest matches
                    if (closestMatches.length === 0) {
                        matchesHtml = '<li>No matches found.</li>';
                    } else {
                        for (var i = 0; i < closestMatches.length; i++) {
                            var saddaDetailsUrl = '{% url 'sadda_details' pk=0 %}'.replace('0', closestMatches[i].id);
                            matchesHtml += '<li><a href="' + saddaDetailsUrl + '">' + closestMatches[i].word + '</a> ('+ closestMatches[i].score +'%)</li>';
                        }
                    }

                    // Update the sadda-closest-matches ul with the generated HTML
                    $('#sadda-closest-matches').html(matchesHtml);
                }
            });

        });


        // Crate vipatti table
        function crate_vipatti() {
            var selectedValue = $('#id_template_selection').val();
            var saddaValue = $('#id_sadda').val();
            
            // Check if template_id and sadda are not empty
            if (selectedValue && saddaValue) {
                $.ajax({
                    url: "{% url 'create_vipatti' template_id=0 sadda=1 %}".replace('1', saddaValue).replace('0', selectedValue),
                    type: 'GET',
                    success: function(response) {
                        var matchesHtml = '';
                        if(response.sadda_type == 'namasaddamala') {
                            matchesHtml += '<table class="w3-table w3-bordered">'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <th>{% trans 'Vibhatti' %}</th>'
                            matchesHtml += '      <th>{% trans 'Ekavacana' %}</th>'
                            matchesHtml += '      <th>{% trans 'Bahuvacana' %}</th>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Paṭhamā' %}</td>'
                            matchesHtml += '      <td>' + response.result.nom_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.nom_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Ālapana' %}</td>'
                            matchesHtml += '      <td>' + response.result.voc_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.voc_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Dutiyā' %}</td>'
                            matchesHtml += '      <td>' + response.result.acc_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.acc_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Tatiyā' %}</td>'
                            matchesHtml += '      <td>' + response.result.instr_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.instr_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Catutthī' %}</td>'
                            matchesHtml += '      <td>' + response.result.dat_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.dat_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Pañcamī' %}</td>'
                            matchesHtml += '      <td>' + response.result.abl_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.abl_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Chaṭṭhī' %}</td>'
                            matchesHtml += '      <td>' + response.result.gen_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.gen_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <td>{% trans 'Sattamī' %}</td>'
                            matchesHtml += '      <td>' + response.result.loc_sg + '</td>'
                            matchesHtml += '      <td>' + response.result.loc_pl + '</td>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '</table>'
                        } else if(response.sadda_type == 'akhyatasaddamala') {
                            matchesHtml += '<table class="w3-table w3-bordered">'
                            matchesHtml += '  <tr>'
                            matchesHtml += '      <th>Vibhatti</th>'
                            matchesHtml += '      <th>Dhātu</th>'
                            matchesHtml += '      <th>Paccaya</th>'
                            matchesHtml += '  </tr>'
                            matchesHtml += '</table>'
                        }

                        $('#result-container').html(matchesHtml);
                    },
                    error: function(xhr, status, error) {
                        // Handle error cases
                        console.error(error);
                    }
                });
            } else {
                // Handle the case when template_id or sadda is empty
                console.log("template_id or sadda is empty");
            }
        }

    </script>
{% endblock %}
